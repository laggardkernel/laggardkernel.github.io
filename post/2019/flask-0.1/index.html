<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Flask 0.1 æºç è§£è¯» - Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="laggardkernel" /><meta name="description" content="åœ¨ç†è§£WSGIè§„èŒƒåï¼Œé˜…è¯»Flask 0.1æºç ï¼Œæ·±å…¥ç†è§£æ•´ä¸ªåº”ç”¨åˆ›å»ºã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ã€‚
" />






<meta name="generator" content="Hugo 0.87.0 with theme even" />


<link rel="canonical" href="https://blog.pseudocold.com/post/2019/flask-0.1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.fa20e845db068df5bd1b183f37f2c2b1ccb88d6fc052a3d6c4f63a682a4d6d4c.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Flask 0.1 æºç è§£è¯»" />
<meta property="og:description" content="åœ¨ç†è§£WSGIè§„èŒƒåï¼Œé˜…è¯»Flask 0.1æºç ï¼Œæ·±å…¥ç†è§£æ•´ä¸ªåº”ç”¨åˆ›å»ºã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.pseudocold.com/post/2019/flask-0.1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-08-20T01:20:54+08:00" />
<meta property="article:modified_time" content="2019-08-20T01:20:54+08:00" />

<meta itemprop="name" content="Flask 0.1 æºç è§£è¯»">
<meta itemprop="description" content="åœ¨ç†è§£WSGIè§„èŒƒåï¼Œé˜…è¯»Flask 0.1æºç ï¼Œæ·±å…¥ç†è§£æ•´ä¸ªåº”ç”¨åˆ›å»ºã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ã€‚"><meta itemprop="datePublished" content="2019-08-20T01:20:54+08:00" />
<meta itemprop="dateModified" content="2019-08-20T01:20:54+08:00" />
<meta itemprop="wordCount" content="3595">
<meta itemprop="keywords" content="flask," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flask 0.1 æºç è§£è¯»"/>
<meta name="twitter:description" content="åœ¨ç†è§£WSGIè§„èŒƒåï¼Œé˜…è¯»Flask 0.1æºç ï¼Œæ·±å…¥ç†è§£æ•´ä¸ªåº”ç”¨åˆ›å»ºã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ã€‚"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/search/">
        <li class="mobile-menu-item">ğŸ”</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Home</a>
</div>

<nav class="site-navbar">
    
      <div class="top-progress-bar"></div>
    
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/search/">ğŸ”</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Flask 0.1 æºç è§£è¯»</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-08-20 </span>
        <div class="post-category">
            <a href="/categories/code-reading/"> Code Reading </a>
            </div>
          <span class="more-meta"> 3595 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#å‡†å¤‡">å‡†å¤‡</a></li>
    <li><a href="#ä¸€åˆ†ä¸ºäºŒ">ä¸€åˆ†ä¸ºäºŒ</a></li>
    <li><a href="#wsgiåº”ç”¨è¯·æ±‚å¤„ç†">WSGIåº”ç”¨ï¼šè¯·æ±‚å¤„ç†</a></li>
    <li><a href="#request-context-å±æ€§">Request Context å±æ€§</a></li>
    <li><a href="#è¾…åŠ©å‡½æ•°ä»¬url_for-flash-get_flashed_messages-render_template">è¾…åŠ©å‡½æ•°ä»¬ï¼šurl_for, flash, get_flashed_messages, render_template</a></li>
    <li><a href="#æ­£é¤flask-ç±»">æ­£é¤ï¼šFlask ç±»</a></li>
    <li><a href="#url_map-vs-url_adapter">url_map v.s. url_adapter</a></li>
    <li><a href="#local-localproxy-localstack">Local, LocalProxy, LocalStack</a>
      <ul>
        <li><a href="#local">Local</a></li>
        <li><a href="#localproxy">LocalProxy</a></li>
        <li><a href="#localstack">LocalStack</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>åœ¨ç†è§£WSGIè§„èŒƒåï¼Œé˜…è¯»Flask 0.1æºç ï¼Œæ·±å…¥ç†è§£æ•´ä¸ªåº”ç”¨åˆ›å»ºã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ã€‚</p>
<h2 id="å‡†å¤‡">å‡†å¤‡</h2>
<p>ç†è®º</p>
<ul>
<li>ç†è§£WSGI</li>
</ul>
<p>å·¥å…· Pycharm</p>
<ul>
<li>åˆ©ç”¨Pycharm structureåˆ†æè„šæœ¬ç»“æ„</li>
<li>Navigate, Symbol è·³è½¬åˆ°æºç å¤„</li>
<li>å…¨å±€æœç´¢</li>
<li>å³å‡»ï¼ŒFind Usage</li>
<li>æŒ‰ä½Ctrlï¼Œè¶…é“¾æ¥æ¨¡å¼è·³è½¬</li>
<li>Shortcuts on macOS
<ul>
<li>Go to declaration, <code>cmd+b</code>.</li>
<li>Go the implementation, <code>cmd+alt+b</code></li>
<li>navigate back, <code>cmd+[</code></li>
</ul>
</li>
</ul>
<h2 id="ä¸€åˆ†ä¸ºäºŒ">ä¸€åˆ†ä¸ºäºŒ</h2>
<p>ä»è¿‡ç¨‹ä¸Šï¼ŒFlaskæºç å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>ç»„è£… <code>Flask</code>ï¼Œåˆ›å»ºåº”ç”¨å®ä¾‹
<ul>
<li>æ³¨å†Œè§†å›¾å‡½æ•°</li>
<li>é”™è¯¯å¤„ç†å‡½æ•°</li>
<li>è¯·æ±‚å‰åçš„é’©å­å‡½æ•°ï¼š<code>@before_request</code>, <code>@after_request</code></li>
<li>åŠ è½½æ¨¡æ¿ä¸Šä¸‹æ–‡
<ul>
<li>é»˜è®¤ä¸Šä¸‹æ–‡å˜é‡ï¼š<code>request</code>, <code>session</code>, <code>g</code></li>
<li>é»˜è®¤ä¸Šä¸‹æ–‡å‡½æ•°ï¼š<code>url_for</code>, <code>get_flashed_messages</code></li>
<li>å…¶ä»–è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å˜é‡</li>
</ul>
</li>
<li>&hellip;</li>
</ul>
</li>
<li>åº”ç”¨å®ä¾‹ä½œä¸ºWSGIåº”ç”¨ç¨‹åºè¢«è°ƒç”¨ï¼Œå¤„ç†è¯·æ±‚
<ul>
<li>æ¿€æ´»è¯·æ±‚ä¸Šä¸‹æ–‡</li>
<li>è°ƒç”¨è¯·æ±‚å‰é’©å­å‡½æ•°åšè¯·æ±‚å‰é¢„å¤„ç†ï¼Œå¦‚æœå‡ºé”™ï¼Œç»ˆæ­¢æ­¤æ¬¡è¯·æ±‚</li>
<li>å¤„ç†è¯·æ±‚ï¼ŒæŸ¥è¯¢å‡ºè¯·æ±‚å¯¹åº”ç«¯ç‚¹ï¼Œå†ç”±ç«¯ç‚¹åŒ¹é…åˆ°è§†å›¾å‡½æ•°å¤„ç†è¯·æ±‚</li>
<li>å°†è§†å›¾å‡½æ•°çš„è¿”å›å€¼å°è£…æˆå“åº”å®ä¾‹</li>
<li>å“åº”åå¤„ç†
<ul>
<li>æ³¨å…¥ <code>session</code> åˆ°å“åº”ï¼Œå› ä¸ºFlaskä¸­ session åŸºäº cookies å®ç°</li>
<li>è°ƒç”¨å“åº”åå¤„ç†é’©å­å‡½æ•°ï¼ˆç”± <code>@after_request</code> æ³¨å†Œï¼‰</li>
</ul>
</li>
<li>è¿”å›å“åº”ç»™WSGIç½‘å…³</li>
</ul>
</li>
</ol>
<p>å°½ç®¡ä»é¡ºåºä¸Šåº”è¯¥ä» <code>Flask</code> å®ä¾‹åˆ›å»ºå¼€å§‹ï¼Œä½†è€ƒè™‘åˆ°å¤§å¤šæ•°äººéƒ½æ˜¯å…ˆäº†è§£ WSGI æ‰æ¥è¯»å¾—æºç ã€‚å®é™…ä»æºç åº•éƒ¨è¯·æ±‚å¤„ç†ä¸Šçœ‹èµ·æ›´æ–¹ä¾¿ç†è§£ã€‚</p>
<h2 id="wsgiåº”ç”¨è¯·æ±‚å¤„ç†">WSGIåº”ç”¨ï¼šè¯·æ±‚å¤„ç†</h2>
<p>ä½œä¸º WSGI åº”ç”¨ï¼Œéœ€è¦åº”ç”¨ç¨‹åºå¯è¢«è°ƒç”¨ï¼Œæˆ–æ˜¯å‡½æ•°ï¼Œæˆ–è€…æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼ˆå¸¦æœ‰ <code>__call__</code> é­”æ³•å‡½æ•°ï¼‰ã€‚</p>
<p>Flask ä»¥ç±» <code>Flask</code> çš„å®ä¾‹ä½œä¸ºWSGIåº”ç”¨ç¨‹åºï¼Œå®é™… <code>__call__</code> æ–¹æ³•å®šä¹‰åœ¨ç±»ä¸Šè¾¹ã€‚ï¼ˆåœ¨æºç å°¾éƒ¨ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Shortcut for :attr:`wsgi_app`&#34;&#34;&#34;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>è€ŒçœŸæ­£è´Ÿè´£å¤„ç†è¯·æ±‚çš„éƒ¨åˆ†åœ¨ <code>Flask.wsgi_app</code> å‡½æ•°ã€‚æ ¹æ®è¢«è°ƒç”¨çš„å‡½æ•°åä»¥åŠPycharmä¸­ &ldquo;Go to implementation&rdquo; ä»¥åŠ &ldquo;Navigate back&rdquo;ï¼Œå¾ˆè½»æ˜“çš„å°±å¯ä»¥ç†è§£è¿™ä¸ªå‡½æ•°çš„è¡Œä¸ºï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;The actual WSGI application.  This is not implemented in
</span><span class="s2">        `__call__` so that middlewares can be applied:
</span><span class="s2">
</span><span class="s2">            app.wsgi_app = MyMiddleware(app.wsgi_app)
</span><span class="s2">
</span><span class="s2">        :param environ: a WSGI environment
</span><span class="s2">        :param start_response: a callable accepting a status code,
</span><span class="s2">                               a list of headers and an optional
</span><span class="s2">                               exception context to start the response
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="c1"># æ¿€æ´»è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå®é™…ä¸ºæ¿€æ´»ä¸€äº›è¯·æ±‚ç›¸å…³ï¼ˆçº¿ç¨‹å±€éƒ¨ï¼‰å…¨å±€å˜é‡ï¼š</span>
        <span class="c1"># request, session, g</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
            <span class="c1"># ä¾æ¬¡è°ƒç”¨é€šè¿‡ `@before_request` è£…é¥°å™¨æ³¨å†Œçš„è¯·æ±‚å‰é’©å­å‡½æ•°åšé¢„å¤„ç†</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
            <span class="c1"># å¦‚æœæŸä¸ªè¯·æ±‚å‰é’©å­å‡½æ•°æœ‰è¿”å›å€¼ï¼Œè¯´æ˜è¯·æ±‚å‰æ£€æµ‹æ²¡æœ‰å®Œæˆï¼ŒæŠ›å‡ºäº†é”™è¯¯</span>
            <span class="c1"># è‹¥è¯·æ±‚é¢„å¤„ç†æ— é”™è¯¯ï¼Œæ´¾é£è¯·æ±‚ï¼ˆå®é™…å°±æ˜¯å¼€å§‹å¤„ç†è¯·æ±‚ï¼‰</span>
            <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_request</span><span class="p">()</span>
                <span class="c1"># å¤„ç†è¯·æ±‚éƒ¨åˆ†éœ€è¦è·³è½¬åˆ°å¯¹åº”å‡½æ•°å®ç°éƒ¨åˆ†</span>
                <span class="c1"># def dispatch_request(self):</span>
                <span class="c1">#     try:</span>
                <span class="c1">#         # ä»æ³¨å†Œçš„urlåˆ—è¡¨ä¸­åŒ¹é…åˆ°è¯¥è¯·æ±‚å¯¹åº”è·¯ç”±</span>
                <span class="c1">#         endpoint, values = self.match_request()</span>
                <span class="c1">#         # æ ¹æ®å¯¹åº”è·¯ç”±ï¼Œè°ƒç”¨å¯¹åº”è§†å›¾å‡½æ•°å¤„ç†è¯·æ±‚</span>
                <span class="c1">#         return self.view_functions[endpoint](**values)</span>
                <span class="c1">#     # è‹¥æŠ›å‡ºé”™è¯¯ï¼Œæ ¹æ®é”™è¯¯çŠ¶æ€ç æŸ¥æ‰¾ @errorhandler æ³¨å†Œçš„é”™è¯¯å¤„ç†å‡½æ•°</span>
                <span class="c1">#     except HTTPException, e:</span>
                <span class="c1">#         handler = self.error_handlers.get(e.code)</span>
                <span class="c1">#     ...</span>

            <span class="c1"># è§†å›¾å‡½æ•°ä¸­æœ‰å¯èƒ½è¿”å›çš„ä¸æ˜¯å“åº”å®ä¾‹ï¼Œä¾‹å¦‚ return render_template(&#39;xxx&#39;), 200</span>
            <span class="c1"># å¤„ç†è§†å›¾å‡½æ•°è¿”å›å€¼ï¼Œåˆ›å»ºå“åº”å®ä¾‹</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
            <span class="c1"># å¯¹è¿”å›çš„ç›¸åº”å®ä¾‹åšåå¤„ç†</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="c1"># def process_response(self, reponse):</span>
            <span class="c1">#     session = _request_ctx_stack.top.session</span>
            <span class="c1">#     # ä¿å­˜sessionåˆ°å“åº”çš„cookiesä¸­ï¼Œå› ä¸ºFlask sessionåŸºäºcookieså®ç°</span>
            <span class="c1">#     if session is not None:</span>
            <span class="c1">#         self.save_session(session, response)</span>
            <span class="c1">#     # è°ƒç”¨ @after_request æ³¨å†Œçš„åå¤„ç†å‡½æ•°</span>
            <span class="c1">#     for handler in self.after_request_funcs:</span>
            <span class="c1">#         response = handler(response)</span>

            <span class="c1"># æ ¹æ® WSGI è§„èŒƒï¼ŒWSGIåº”ç”¨å®ä¾‹ä½¿ç”¨ä¼ å…¥çš„ environ, startreponse</span>
            <span class="c1"># ç”Ÿæˆå“åº”ï¼Œè¿”å›ç»™ WSGIç½‘å…³</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>æ˜ç™½äº†è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åè¿‡æ¥ä»å¤´å¼€å§‹é˜…è¯»æºç ï¼Œç†è§£ Flask ç±»çš„ç»„è£…ã€‚ä¸è¿‡åœ¨å¼€å§‹ä¹‹å‰ï¼Œä¼šå…ˆç¢°åˆ° <code>_RequestContext</code>ã€‚</p>
<h2 id="request-context-å±æ€§">Request Context å±æ€§</h2>
<p>å¯¹äºè¯·æ±‚ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…ˆä¸ç”¨æ·±å…¥å…¶åŸºäº <code>LocalStack</code> çš„å‹æ ˆã€å‡ºæ ˆï¼Œæˆ–ä½¿å…¶æŸäº›å±æ€§å¦‚ä½•åŸºäº <code>LocalProxy</code> å®ç°ã€‚å…ˆæŠŠ <code>_RequestContext</code> å±æ€§ï¼ˆå®ƒæ˜¯ä»€ä¹ˆï¼‰ä»¥åŠå®ƒçš„ä½œç”¨ç†è§£å°±å¯ä»¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">_RequestContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># è¯·æ±‚ä¸Šä¸‹æ–‡è¢«ç”¨äºå­˜å‚¨è¯·æ±‚ç›¸å…³ä¿¡æ¯ï¼ŒåŒæ—¶ç”ŸæˆWSGIç¯å¢ƒæ‰€éœ€çš„è¯·æ±‚å¯¹è±¡ã€URLè½¬æ¢å™¨</span>
    <span class="s2">&#34;&#34;&#34;The request context contains all request relevant information.  It is
</span><span class="s2">    created at the beginning of the request and pushed to the
</span><span class="s2">    `_request_ctx_stack` and removed at the end of it.  It will create the
</span><span class="s2">    URL adapter and request object for the WSGI environment provided.
</span><span class="s2">    &#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="c1"># url_map å±æ€§æ˜¯ä¸€ä¸ªMapå¯¹è±¡ï¼Œå®ƒè°ƒç”¨ bind_to_environ() æ–¹æ³•ï¼Œ</span>
        <span class="c1"># è¿”å›ä¸€ä¸ªMapAdapterç±»å®ä¾‹ã€‚æ­¤å®ä¾‹è´Ÿè´£åŒ¹é…å’Œæ„å»ºURL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_adapter</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">bind_to_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">open_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># è·³è½¬åˆ° open_session å®ç°å¯çŸ¥ session åŸºäº cookies å®ç°</span>
        <span class="c1"># def open_session(self, request):</span>
        <span class="c1">#     key = self.secret_key</span>
        <span class="c1">#     if key is not None:</span>
        <span class="c1">#         return SecureCookie.load_cookie(request, self.session_cookie_name,</span>
        <span class="c1">#                                         secret_key=key)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">_RequestGlobals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flashes</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># request context çš„æ¿€æ´»ä½¿ç”¨</span>
<span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
            <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">request_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_RequestContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="è¾…åŠ©å‡½æ•°ä»¬url_for-flash-get_flashed_messages-render_template">è¾…åŠ©å‡½æ•°ä»¬ï¼šurl_for, flash, get_flashed_messages, render_template</h2>
<p>è¿™ä¸€éƒ¨åˆ†ååˆ†å®¹æ˜“ç†è§£ã€‚æ³¨æ„ <code>url_for</code> ä¸­ <code>url_adapter</code>ï¼Œåœ¨åè¾¹æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ç†è§£ä¸€ä¸‹ <code>url_map</code>, <code>url_adapter</code> å…³ç³»ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">):</span>
    <span class="c1"># æ ¹æ®ä¼ å…¥çš„ç«¯ç‚¹è¿”å›å¯¹åº”çš„URL</span>
    <span class="k">return</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">url_adapter</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">flash</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="c1"># flash msgs å®é™…è¢«å­˜åœ¨äº session ä¸­.</span>
    <span class="c1"># ä½¿ç”¨ session è€Œé g ä»¥ä¿è¯é—ªç°æ¶ˆæ¯å¯ä»¥è·¨è¯·æ±‚å­˜æ´»ï¼Œåœ¨åé¢è¯·æ±‚ä¸­è¢«æ¸²æŸ“</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;_flashes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_flashes&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">+</span> <span class="p">[</span><span class="n">message</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_flashed_messages</span><span class="p">():</span>
    <span class="c1"># é€šè¿‡ session.pop å¼¹å‡ºæ¶ˆæ¯ä½¿å…¶è¢«ä½¿ç”¨åå¤±æ•ˆï¼Œ</span>
    <span class="c1"># æš‚å­˜åœ¨ _RequestContext.flashes ä»¥é˜²è¢«å¤šæ¬¡æ¸²æŸ“åˆ°æ¨¡æ¿</span>
    <span class="n">flashes</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">flashes</span>
    <span class="k">if</span> <span class="n">flashes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">flashes</span> <span class="o">=</span> <span class="n">flashes</span> <span class="o">=</span> \
            <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_flashes&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">flashes</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè°ƒç”¨jinjaæ¸²æŸ“æ¨¡æ¿</span>
    <span class="c1"># æ³¨æ„ update_template_context ä¼šè°ƒè‡ªå®šä¹‰çš„ template_context å¤„ç†å‡½æ•°</span>
    <span class="c1"># æ›´æ–°æ¨¡æ¿ä¸Šä¸‹æ–‡</span>
    <span class="n">current_app</span><span class="o">.</span><span class="n">update_template_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">update_template_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">reqctx</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_context_processors</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="æ­£é¤flask-ç±»">æ­£é¤ï¼šFlask ç±»</h2>
<p>Flask ç±»ä½œä¸ºWSGIå¼•ç”¨çš„æ ¸å¿ƒï¼Œå……å½“ç€æ³¨å†Œä¸­å¿ƒçš„è§’è‰²ã€‚æ³¨å†Œè§†å›¾å‡½æ•°ã€URLè§„åˆ™ã€æ¨¡æ¿é…ç½®ã€å‰åå¤„ç†é’©å­å‡½æ•°ç­‰ç­‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">package_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">_get_package_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

        <span class="c1"># è§†å›¾å‡½æ•°ã€é”™è¯¯å¤„ç†å‡½æ•°ã€è¯·æ±‚å‰åé’©å­å‡½æ•°ç­‰å­˜å‚¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_request_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_request_funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_context_processors</span> <span class="o">=</span> <span class="p">[</span><span class="n">_default_template_ctx_processor</span><span class="p">]</span>

        <span class="c1"># url_map ä¸º Werkzeug Mapå®ä¾‹ï¼Œå­˜å‚¨URLè§„åˆ™åŠç›¸å…³é…ç½®</span>
        <span class="c1"># ä¸»è¦é€šè¿‡å­˜å‚¨ Rule å®ä¾‹ï¼Œä¿å­˜äº†ç«¯ç‚¹å’ŒURLè§„åˆ™çš„æ˜ å°„</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># è®°å½•é™æ€æ–‡ä»¶è·¯ç”±ï¼ˆå¦‚ `/static/&lt;filename&gt;`ï¼‰ä¸ç«¯ç‚¹ &#39;static&#39; æ˜ å°„å…³ç³»</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_path</span> <span class="o">+</span> <span class="s1">&#39;/&lt;filename&gt;&#39;</span><span class="p">,</span>
                                  <span class="n">build_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;static&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pkg_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
            <span class="c1"># é€šè¿‡SharedDataMiddlewareè®°å½•è·¯ç”±ä¸æ“ä½œç³»ç»Ÿä¸ŠçœŸå®æ–‡ä»¶è·¯å¾„å…³ç³»</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">SharedDataMiddleware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">static_path</span><span class="p">:</span> <span class="n">target</span>
            <span class="p">})</span>

        <span class="c1"># jinja ç¯å¢ƒåˆ›å»ºï¼Œé»˜è®¤åŠ è½½ url_for, get_flashed_messages åˆ°æ¨¡æ¿ä¸Šä¸‹æ–‡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_jinja_loader</span><span class="p">(),</span>
                                     <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">jinja_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">url_for</span><span class="o">=</span><span class="n">url_for</span><span class="p">,</span>
            <span class="n">get_flashed_messages</span><span class="o">=</span><span class="n">get_flashed_messages</span>
        <span class="p">)</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">open_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># ä»è¯·æ±‚æºå¸¦çš„ cookies ä¸­è·å–sessionï¼Œæˆ–è€…åˆ›å»ºæ–° session</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecureCookie</span><span class="o">.</span><span class="n">load_cookie</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">,</span>
                                            <span class="n">secret_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c1"># åµŒå…¥ session åˆ° response cookiesä¸­</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">save_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_url_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># æ³¨å†Œç«¯ç‚¹ä¸URLè§„åˆ™åˆ°åº”ç”¨å®ä¾‹ url_map å±æ€§</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;methods&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># @route è£…é¥°å™¨ï¼Œå®é™…ä»ä¸ºè°ƒç”¨ add_url_rule æ³¨å†Œè§†å›¾å‡½æ•°åˆ°åº”ç”¨å®ä¾‹</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="c1"># æ¥ä¸‹æ¥æ˜¯ä¸€ç³»åˆ—çš„è£…é¥°å™¨å®šä¹‰ï¼Œç”¨æ¥æ·»åŠ è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†ã€è¯·æ±‚å‰åé’©å­</span>
    <span class="k">def</span> <span class="nf">errorhandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">before_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">context_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨æºç çš„æœ€åº•ç«¯ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† wsgi_app å‡½æ•°è¯·æ±‚å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™å†å›è¿‡æ¥çœ‹ä¸€éè¯·æ±‚å¤„ç†æ€è·¯å°±æ¸…æ™°åº¦äº†ã€‚</p>
<h2 id="url_map-vs-url_adapter">url_map v.s. url_adapter</h2>
<p>url_map ä¸º Werkzeug Mapå®ä¾‹ï¼Œè®°å½•ç«¯ç‚¹ä¸URLè§„åˆ™æ˜ å°„ã€‚è€Œ url_map é€šè¿‡è°ƒç”¨ <code>.bind_to_envrion</code> è¿”å› url_adapterï¼Œurl_adapter æ ¹æ®ç«¯ç‚¹è°ƒç”¨ <code>.bind()</code> å¯ä»¥æ„å»ºå‡ºå¯¹åº”çš„URLã€‚</p>
<p>url_mapç”¨äºè®°å½•æ˜ å°„ï¼Œurl_adapter è´Ÿè´£åæŸ¥ã€æˆ–è€…æ„é€ URLã€‚å‰è€…æ— è¯·æ±‚ä¿¡æ¯ï¼Œåè€…ç»‘å®šäº†è¯·æ±‚ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">_RequestContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="c1"># url_map å±æ€§æ˜¯ä¸€ä¸ªMapå¯¹è±¡ï¼Œå®ƒè°ƒç”¨ bind_to_environ() æ–¹æ³•ï¼Œ</span>
        <span class="c1"># è¿”å›ä¸€ä¸ªMapAdapterç±»å®ä¾‹ã€‚æ­¤å®ä¾‹è´Ÿè´£åŒ¹é…å’Œæ„å»ºURL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_adapter</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">bind_to_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">):</span>
    <span class="c1"># æ ¹æ®ä¼ å…¥çš„ç«¯ç‚¹è¿”å›å¯¹åº”çš„URL</span>
    <span class="k">return</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">url_adapter</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>å®é™…åº”ç”¨å®ä¾‹å¤„ç†è¯·æ±‚æ—¶</p>
<ol>
<li>é€šè¿‡ url_adapter è°ƒç”¨ <code>.match()</code> æŸ¥è¯¢å‡ºå½“å‰è¯·æ±‚å¯¹åº”çš„ç«¯ç‚¹ã€è§†å›¾å‚æ•°</li>
<li>æ ¹æ®æŸ¥è¯¢å‡ºçš„ç«¯ç‚¹è°ƒç”¨å¯¹åº”çš„è§†å›¾å‡½æ•°å¤„ç†è¯·æ±‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># url_map ä¸º Werkzeug Mapå®ä¾‹ï¼Œå­˜å‚¨URLè§„åˆ™åŠç›¸å…³é…ç½®</span>
        <span class="c1"># ä¸»è¦é€šè¿‡å­˜å‚¨ Rule å®ä¾‹ï¼Œä¿å­˜äº†ç«¯ç‚¹å’ŒURLè§„åˆ™çš„æ˜ å°„</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">match_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">url_adapter</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">view_args</span> <span class="o">=</span> <span class="n">rv</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_request</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="n">endpoint</span><span class="p">](</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
            <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="local-localproxy-localstack">Local, LocalProxy, LocalStack</h2>
<p>è¿™ä¸€éƒ¨åˆ†å…¶å®ä¸äº†è§£ä¹Ÿèƒ½è¯»æ‡‚æ•´ä¸ªFlaskæµç¨‹ï¼Œåªè®°ä½ä¸€ä¸‹ä¸€äº›æ¦‚å¿µå³å¯ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹æºç æ·±ç©¶ã€‚å¯ä»¥å‚çœ‹ æè¾‰ çš„ã€ŠFlask Webå¼€å‘å®æˆ˜ã€‹ä¹¦ä¸­æœ€åä¸€ç« ã€‚</p>
<p>ç›®å‰æ¨èå…ˆé˜…è¯»ä¹‹åçš„å‡ ç‰ˆæºç ï¼Œå¼„æ¸…æ¥šåæ¥ä¸€äº›ç‰¹æ€§çš„å®ç°ã€‚</p>
<h3 id="local">Local</h3>
<p>Flaskä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹å¤„ç†ï¼Œå¼•å…¥äº†æœ¬åœ°çº¿ç¨‹ï¼ˆThread Localï¼‰çš„æ¦‚å¿µï¼Œåœ¨ä¿å­˜æ•°æ®çš„åŒæ—¶è®°å½•ä¸‹å¯¹åº”çš„çº¿ç¨‹IDï¼Œè·å–æ•°æ®æ—¶æ ¹æ®æ‰€åœ¨çº¿ç¨‹çš„IDå³å¯è·å–åˆ°å¯¹åº”çš„æ•°æ®ã€‚ï¼ˆç®€å•åœ°è¯´ï¼Œè™½ç„¶æ‰€æœ‰çº¿ç¨‹çœ‹æ¥åœ¨ä½¿ç”¨ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå®é™…ä¸Šæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å…¨å±€å¯¹è±¡ä¸‹å½“å‰çº¿ç¨‹å¯¹åº”çš„åŒåå˜é‡ï¼‰</p>
<p>Pythonå†…ç½®æ¨¡å— <code>threading.local</code> å°±æ˜¯å¯¹äºæœ¬åœ°çº¿ç¨‹çš„ä¸€ç§å®ç°ã€‚</p>
<p>æ ¹æ® Werkzeugï¼Œ<code>threading.local</code> å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œä¸èƒ½æ»¡è¶³å…¶é¡¹ç›®éœ€æ±‚ã€‚</p>
<blockquote>
<p>This (<code>threading.local</code>) approach, however, has a few disadvantages. For example, besides threads, there are <strong>other types of concurrency</strong> in Python. A very popular one is greenlets. Also, whether every request gets its own thread is not guaranteed in WSGI. It could be that a request is reusing a thread from a previous request, and hence data is left over in the thread local object.</p>
</blockquote>
<p>äºæ˜¯ï¼ŒWerkzeug åŸºäº greenlet å®ç°æœ¬åœ°çº¿ç¨‹ <code>Local</code> ç±»ï¼Œå…¶è¦†ç›–æ€§æ›´å¥½ã€‚</p>
<h3 id="localproxy">LocalProxy</h3>
<p>ä»£ç†ï¼ˆProxyï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªä»£ç†å¯¹è±¡æ¥æ“ä½œå®é™…å¯¹è±¡ã€‚ä¹ä¸€çœ‹ï¼Œä½ å¯èƒ½ä¼šè§‰å¾— Flask åƒé¥±æ’‘çš„ä¸ç”¨ <code>Local</code> è€Œè¦é€šè¿‡ <code>LocalProxy</code> å¥—ä¸€å±‚ã€‚</p>
<p>å› ä¸ºä¸Šä¸‹æ–‡çš„æ¨é€å’Œç§»é™¤æ˜¯åŠ¨æ€è¿›è¡Œçš„ï¼ŒFlask ä½¿ç”¨ä»£ç†å¯ä»¥è®©æˆ‘ä»¬æ‹¥æœ‰åŠ¨æ€è·å–ä¸Šä¸‹æ–‡å¯¹è±¡çš„èƒ½åŠ›ã€‚
å¦å¤–ï¼Œä¸€ä¸ªåŠ¨æ€çš„å…¨å±€å¯¹è±¡ï¼Œä¹Ÿè®©å¤šä¸ªç¨‹åºå®ä¾‹å¹¶å­˜æœ‰äº†å¯èƒ½ã€‚è¿™æ ·åœ¨ä¸åŒçš„ç¨‹åºä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ï¼Œ<code>current_app</code> æ€»æ˜¯èƒ½å¯¹åº”æ­£ç¡®çš„ç¨‹åºå®ä¾‹ã€‚</p>
<h3 id="localstack">LocalStack</h3>
<p><code>LocalStack</code> åªæ˜¯åŸºäº <code>Local</code> å®ç°çš„æ ˆç»“æ„ã€‚</p>
<p>ä¸ºä»€ä¹ˆ Flask ä½¿ç”¨ <code>LocalStack</code> è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>Local</code> å­˜å‚¨ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ä¸»è¦çš„åŸå› æ˜¯ä¸ºäº†æ”¯æŒå¤šç¨‹åºå…±å­˜ã€‚å°†ç¨‹åºåˆ†ç¦»æˆå¤šä¸ªç¨‹åºå¾ˆç±»ä¼¼è“æœ¬çš„æ¨¡å—åŒ–åˆ†ç¦»ï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯ä¸€å›äº‹ã€‚ä½¿ç”¨Werkzeugæä¾›çš„ <code>DispatcherMiddleware</code> ä¸­é—´ä»¶å°±å¯ä»¥æŠŠå¤šä¸ªç¨‹åºç»„åˆæˆä¸€ä¸ªWSGIç¨‹åºè¿è¡Œã€‚</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/pallets/flask">Flask on GitHub</a></li>
<li><a href="https://werkzeug.palletsprojects.com/en/0.15.x/local/">Werkzueg: Context Locals</a></li>
<li>ã€ŠFlask Webå¼€å‘å®æˆ˜ã€‹ï¼Œæè¾‰</li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">laggardkernel</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2019-08-20
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flask/">flask</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2019/flask-pitfalls/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Flask Pitfalls</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2019/wsigref-code-reading/">
            <span class="next-text nav-default">wsigref æºç é˜…è¯»ç¬”è®°</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'pseudocold';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://stackoverflow.com/users/5101148" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://github.com/laggardkernel" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.pseudocold.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>laggardkernel</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.db1482bc438a2df971757df91e110bb84b31bb77ca2141978d165fcf453c642e.js"></script>








</body>
</html>
